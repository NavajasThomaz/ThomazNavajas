{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 40, "column": 0}, "map": {"version":3,"sources":["file:///Users/thomaznavajas/Projetos/ThomazNavajas/app/api/chat/route.ts"],"sourcesContent":["import { NextResponse } from \"next/server\"\n\nexport const maxDuration = 30\nexport const runtime = \"nodejs\"\nexport const dynamic = \"force-dynamic\"\n\ntype ChatMessage = {\n  role: \"user\" | \"assistant\"\n  text: string\n}\n\nconst ABACUS_API_URL = process.env.ABACUS_API_URL || \"https://apps.abacus.ai\"\nconst ABACUS_DEPLOYMENT_TOKEN = process.env.ABACUS_DEPLOYMENT_TOKEN\nconst ABACUS_DEPLOYMENT_ID = process.env.ABACUS_DEPLOYMENT_ID\nconst ABACUS_API_KEY = process.env.ABACUS_API_KEY\nconst ABACUS_CONVERSATION_ID = process.env.ABACUS_CONVERSATION_ID\n\nasync function callAbacus(\n  action: string,\n  {\n    body,\n    query,\n  }: {\n    body?: Record<string, unknown>\n    query?: Record<string, string | undefined>\n  },\n) {\n  const headers: Record<string, string> = {\n    \"Content-Type\": \"application/json\",\n  }\n  if (ABACUS_API_KEY) {\n    headers.apiKey = ABACUS_API_KEY\n  }\n\n  const searchParams = new URLSearchParams()\n  Object.entries(query || {}).forEach(([k, v]) => {\n    if (v) searchParams.append(k, v)\n  })\n\n  const hosts = [ABACUS_API_URL]\n  if (!hosts.includes(\"https://api.abacus.ai\")) {\n    hosts.push(\"https://api.abacus.ai\")\n  }\n  const attempted: string[] = []\n\n  for (const host of hosts) {\n    const url = `${host}/api/v0/${action}?${searchParams.toString()}`\n    attempted.push(url)\n    try {\n      const res = await fetch(url, {\n        method: \"POST\",\n        headers,\n        body: JSON.stringify(body || {}),\n        cache: \"no-store\",\n      })\n\n      if (!res.ok) {\n        const errorText = await res.text().catch(() => \"\")\n        throw new Error(errorText || `Falha em ${action} (status ${res.status})`)\n      }\n\n      const json = await res.json()\n      if (json?.success === false) {\n        throw new Error(json?.error || `Erro em ${action}`)\n      }\n      return json?.result ?? json\n    } catch (err: any) {\n      // tenta próximo host; se for o último, propaga detalhe\n      if (host === hosts[hosts.length - 1]) {\n        const msg = err?.message || \"Erro ao chamar Abacus\"\n        throw new Error(`${msg} | attempted: ${attempted.join(\", \")}`)\n      }\n    }\n  }\n\n  throw new Error(`Erro ao chamar ${action} | attempted: ${attempted.join(\", \")}`)\n}\n\nexport async function POST(req: Request) {\n  if (!ABACUS_DEPLOYMENT_TOKEN || !ABACUS_DEPLOYMENT_ID) {\n    return NextResponse.json(\n      { error: \"Configuração da Abacus ausente. Defina ABACUS_DEPLOYMENT_TOKEN e ABACUS_DEPLOYMENT_ID.\" },\n      { status: 500 },\n    )\n  }\n\n  const payload = await req.json()\n  const bodyMessages: ChatMessage[] | undefined = payload?.messages\n  const explicitText: string | undefined = payload?.message || payload?.text\n  const incomingConversationId: string | undefined = payload?.conversationId\n  const incomingExternalSessionId: string | undefined = payload?.externalSessionId\n\n  const userText =\n    explicitText ||\n    (Array.isArray(bodyMessages)\n      ? [...bodyMessages].reverse().find((m) => m.role === \"user\")?.text\n      : undefined)\n\n  if (!userText?.trim()) {\n    return NextResponse.json({ error: \"Mensagem do usuário ausente.\" }, { status: 400 })\n  }\n\n  let conversationId = incomingConversationId || ABACUS_CONVERSATION_ID || null\n  let externalSessionId = incomingExternalSessionId || conversationId || null\n\n  try {\n    if (!conversationId) {\n      const convo = await callAbacus(\"createDeploymentConversation\", {\n        query: { deploymentId: ABACUS_DEPLOYMENT_ID, deploymentToken: ABACUS_DEPLOYMENT_TOKEN },\n        body: {},\n      })\n      conversationId =\n        convo?.deploymentConversationId ||\n        convo?.deployment_conversation_id ||\n        convo?.id ||\n        convo?.conversationId ||\n        convo?.conversation_id\n      externalSessionId = conversationId\n    }\n\n    const headers: Record<string, string> = {\n      \"Content-Type\": \"application/json\",\n      Accept: \"text/event-stream\",\n    }\n    if (ABACUS_API_KEY) {\n      headers.apiKey = ABACUS_API_KEY\n    }\n\n    const searchParams = new URLSearchParams({\n      deploymentToken: ABACUS_DEPLOYMENT_TOKEN,\n      deploymentId: ABACUS_DEPLOYMENT_ID,\n    })\n\n    const body = {\n      message: userText,\n      deploymentConversationId: conversationId,\n      externalSessionId,\n      temperature: 0,\n      ignoreDocuments: false,\n      includeSearchResults: true,\n      executeUsercodeTool: true,\n    }\n\n    const baseHosts = [ABACUS_API_URL]\n    if (!baseHosts.includes(\"https://api.abacus.ai\")) {\n      baseHosts.push(\"https://api.abacus.ai\")\n    }\n\n    let abacusRes: Response | null = null\n    const attempted: string[] = []\n    for (const host of baseHosts) {\n      const abacusUrl = `${host}/api/getStreamingConversationResponse?${searchParams.toString()}`\n      attempted.push(abacusUrl)\n      try {\n        const res = await fetch(abacusUrl, {\n          method: \"POST\",\n          headers,\n          body: JSON.stringify(body),\n          cache: \"no-store\",\n        })\n        if (res.ok && res.body) {\n          abacusRes = res\n          break\n        }\n        const errorText = await res.text().catch(() => \"\")\n        return NextResponse.json(\n          {\n            error: errorText || \"Falha ao chamar getStreamingConversationResponse\",\n            status: res.status,\n            statusText: res.statusText,\n            url: abacusUrl,\n          },\n          { status: res.status || 502 },\n        )\n      } catch (fetchErr: any) {\n        // tenta próxima opção\n        if (host === baseHosts[baseHosts.length - 1]) {\n          return NextResponse.json(\n            {\n              error: fetchErr?.message || \"Falha de rede ao contatar Abacus\",\n              attempted,\n            },\n            { status: 502 },\n          )\n        }\n      }\n    }\n\n    if (!abacusRes || !abacusRes.body) {\n      return NextResponse.json(\n        { error: \"Falha ao contatar Abacus.AI\", attempted: baseHosts },\n        { status: 502 },\n      )\n    }\n\n    const encoder = new TextEncoder()\n    const decoder = new TextDecoder()\n    let lastJson: any = null\n\n    const stream = new ReadableStream({\n      async start(controller) {\n        const reader = abacusRes.body!.getReader()\n        let buffer = \"\"\n        try {\n          while (true) {\n            const { done, value } = await reader.read()\n            if (done) break\n            buffer += decoder.decode(value, { stream: true })\n            const lines = buffer.split(\"\\n\")\n            buffer = lines.pop() || \"\"\n            for (const line of lines) {\n              const trimmed = line.trim()\n              if (!trimmed) continue\n              const payloadLine = trimmed.startsWith(\"data:\") ? trimmed.slice(5).trim() : trimmed\n              if (payloadLine === \"[DONE]\") {\n                controller.enqueue(encoder.encode(\"data: [DONE]\\n\"))\n                continue\n              }\n              try {\n                const obj = JSON.parse(payloadLine)\n                lastJson = obj\n              } catch {\n                // ignore parse errors\n              }\n              controller.enqueue(encoder.encode(trimmed.startsWith(\"data:\") ? `${trimmed}\\n` : `data: ${trimmed}\\n`))\n            }\n          }\n          if (buffer.trim()) {\n            const trimmed = buffer.trim()\n            const payloadLine = trimmed.startsWith(\"data:\") ? trimmed.slice(5).trim() : trimmed\n            try {\n              const obj = JSON.parse(payloadLine)\n              lastJson = obj\n            } catch {\n              // ignore\n            }\n            controller.enqueue(encoder.encode(trimmed.startsWith(\"data:\") ? `${trimmed}\\n` : `data: ${trimmed}\\n`))\n          }\n          if (lastJson) {\n            const meta = {\n              conversationId:\n                lastJson?.deploymentConversationId ||\n                lastJson?.deployment_conversation_id ||\n                lastJson?.conversationId ||\n                lastJson?.conversation_id ||\n                conversationId,\n              externalSessionId: lastJson?.externalSessionId || lastJson?.external_session_id || externalSessionId,\n            }\n            controller.enqueue(encoder.encode(`data: ${JSON.stringify({ meta })}\\n`))\n          }\n          controller.enqueue(encoder.encode(\"data: [DONE]\\n\"))\n        } catch (err) {\n          controller.enqueue(\n            encoder.encode(`data: ${JSON.stringify({ error: (err as Error)?.message || \"stream error\" })}\\n`),\n          )\n          controller.enqueue(encoder.encode(\"data: [DONE]\\n\"))\n          controller.error(err)\n        } finally {\n          controller.close()\n        }\n      },\n    })\n\n    return new Response(stream, {\n      headers: {\n        \"Content-Type\": \"text/event-stream\",\n        \"Cache-Control\": \"no-cache, no-transform\",\n        Connection: \"keep-alive\",\n      },\n    })\n  } catch (err: any) {\n    return NextResponse.json({ error: err?.message || \"Erro ao consultar a Abacus.AI\" }, { status: 500 })\n  }\n}\n"],"names":[],"mappings":"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"}}]
}